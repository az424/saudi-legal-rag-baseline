<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Saudi Legal RAG Demo</title>

  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    textarea {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-top: 10px;
    }
    button {
      margin-top: 10px;
      padding: 10px 16px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      background: #007bff;
      color: white;
    }
    .answer {
      margin-top: 20px;
      white-space: pre-wrap;
      background: #fafafa;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #eee;
    }
    .articles {
      margin-top: 15px;
      background: #fdfdfd;
      padding: 10px;
      border-radius: 8px;
      border: 1px dashed #ddd;
    }

    /* ⭐ Improved Star Rating Styling */
    .rating-wrapper {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .rating-group {
      direction: ltr;
      display: flex;
      gap: 5px;
      cursor: pointer;
      font-size: 34px;
    }
    .star {
      color: #ccc;
      transition: 0.2s;
    }
    .star.selected {
      color: gold;
    }
    .rating-value {
      font-size: 18px;
      color: #007bff;
      font-weight: bold;
      min-width: 30px;
    }

    .eval-box {
      margin-top: 20px;
      padding: 15px;
      background: #fdfdfd;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    .success {
      color: green;
      margin-top: 10px;
      font-weight: bold;
    }
    .fail {
      color: red;
      margin-top: 10px;
      font-weight: bold;
    }
  </style>
</head>
<body>

  <div class="container">
    <h2>Saudi Legal RAG Interface</h2>

    <!-- ✔ Added Researcher Info -->
    <p style="font-size: 18px; font-weight: bold; color:#444;">
      باحث دكتوراه في نظم المعلومات: <span style="color:#007bff;">عبدالعزيز عبدالله الرويلي</span>
    </p>

    <p>اكتب سؤالك القانوني وسيتم الإجابة بالاستناد إلى الأنظمة السعودية.</p>

    <textarea id="question" rows="4"></textarea>
    <button id="askBtn">إرسال السؤال</button>

    <div id="status"></div>

    <div id="result" style="display:none;">
      <h3>الإجابة:</h3>
      <div id="answer" class="answer"></div>

      <h3>المواد النظامية المستخدمة:</h3>
      <ul id="articles" class="articles"></ul>

      <!-- ⭐ تقييم الإجابة -->
      <div class="eval-box">
        <h3>تقييم الإجابة</h3>

        <div>
          <label>الدقة Accuracy:</label>
          <div class="rating-wrapper">
            <div class="rating-group" id="acc-stars"></div>
            <div class="rating-value" id="acc-value">0</div>
          </div>
        </div>

        <div>
          <label>الوضوح Clarity:</label>
          <div class="rating-wrapper">
            <div class="rating-group" id="clarity-stars"></div>
            <div class="rating-value" id="clarity-value">0</div>
          </div>
        </div>

        <div>
          <label>العمق القانوني Legal Depth:</label>
          <div class="rating-wrapper">
            <div class="rating-group" id="depth-stars"></div>
            <div class="rating-value" id="depth-value">0</div>
          </div>
        </div>

        <div>
          <label>التقييم العام Overall Score:</label>
          <div class="rating-wrapper">
            <div class="rating-group" id="overall-stars"></div>
            <div class="rating-value" id="overall-value">0</div>
          </div>
        </div>

        <button id="evalBtn">إرسال التقييم</button>
        <div id="evalStatus"></div>
      </div>
    </div>
  </div>

  <script>
    const askBtn = document.getElementById("askBtn");
    const evalBtn = document.getElementById("evalBtn");
    const questionInput = document.getElementById("question");
    const answerEl = document.getElementById("answer");
    const articlesEl = document.getElementById("articles");
    const resultEl = document.getElementById("result");
    const statusEl = document.getElementById("status");
    const evalStatus = document.getElementById("evalStatus");

    // ⭐ Enhanced star function
    function createStars(containerId, valueId) {
      const container = document.getElementById(containerId);
      const valueBox = document.getElementById(valueId);

      for (let i = 1; i <= 5; i++) {
        const span = document.createElement("span");
        span.classList.add("star");
        span.innerHTML = "★";
        span.dataset.value = i;

        span.onclick = () => {
          const rating = Number(span.dataset.value);
          container.dataset.selected = rating;

          [...container.children].forEach(s => s.classList.remove("selected"));
          for (let j = 0; j < rating; j++) {
            container.children[j].classList.add("selected");
          }

          valueBox.textContent = rating;
        };

        container.appendChild(span);
      }

      container.dataset.selected = 0;
      valueBox.textContent = 0;
    }

    // ⭐ Initialize rating groups
    createStars("acc-stars", "acc-value");
    createStars("clarity-stars", "clarity-value");
    createStars("depth-stars", "depth-value");
    createStars("overall-stars", "overall-value");

    // =============================
    // 1) Ask RAG backend
    // =============================
    askBtn.onclick = async () => {
      const question = questionInput.value.trim();
      if (!question) return alert("اكتب سؤالاً.");

      statusEl.textContent = "جاري المعالجة...";
      resultEl.style.display = "none";
      evalStatus.textContent = "";

      const response = await fetch("https://rag-backend-55de.onrender.com/ask", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({question})
      });

      const data = await response.json();

      statusEl.textContent = "";
      resultEl.style.display = "block";

      answerEl.textContent = data.answer;
      articlesEl.innerHTML = "";

      if (data.articles && data.articles.length > 0) {
        data.articles.forEach(a => {
          const li = document.createElement("li");
          li.textContent = `${a.ref} ${a.system} (${a.system_code}) – ${a.article_number} – ${a.article_key}`;
          articlesEl.appendChild(li);
        });
      }
    };

    // =============================
    // 2) Submit evaluation
    // =============================
    evalBtn.onclick = async () => {
      const evaluation = {
        question: questionInput.value,
        answer: answerEl.textContent,
        accuracy: Number(document.getElementById("acc-stars").dataset.selected),
        clarity: Number(document.getElementById("clarity-stars").dataset.selected),
        legal_depth: Number(document.getElementById("depth-stars").dataset.selected),
        relevance: 0,
        overall_score: Number(document.getElementById("overall-stars").dataset.selected),
      };

      const response = await fetch("https://rag-backend-55de.onrender.com/evaluate", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(evaluation)
      });

      const data = await response.json();

      if (data.status === "saved") {
        evalStatus.innerHTML = "<span class='success'>✔️ تم حفظ التقييم بنجاح</span>";
      } else {
        evalStatus.innerHTML = "<span class='fail'>❌ تعذر حفظ التقييم</span>";
      }
    };
  </script>
</body>
</html>
